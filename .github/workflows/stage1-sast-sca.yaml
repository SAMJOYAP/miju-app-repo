name: Stage 1 - SAST & SCA

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  SONAR_HOST_URL: http://sonar.local
  APP_NAME: miju-app

jobs:
  snyk-scan:
    name: Snyk Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Run Snyk to check dependencies
        uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --file=requirements.txt --severity-threshold=medium
      
      - name: Snyk Code Analysis
        uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test
  
  bandit-scan:
    name: Bandit Security Linter
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install Bandit
        run: pip install bandit[sarif]
      
      - name: Run Bandit scan
        run: |
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -f txt || true
      
      - name: Upload Bandit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-report
          path: bandit-report.json
  
  security-summary:
    name: Stage 1 Summary
    runs-on: ubuntu-latest
    needs: [snyk-scan, bandit-scan]
    if: always()
    
    steps:
      - name: Stage 1 Complete
        run: |
          echo "‚úÖ Stage 1: SAST & SCA completed"
          echo "üîç Snyk: Dependency & code scanning done"
          echo "üêç Bandit: Python security linting done"
          echo "‚ö†Ô∏è  SonarQube: Skipped (requires local server access)"
          echo "‚û°Ô∏è  Proceeding to Stage 2"
