name: Stage 1 - SAST & SCA

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  SONAR_HOST_URL: http://sonar.local
  APP_NAME: miju-app

jobs:
  sonarqube-scan:
    name: SonarQube Code Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=${{ env.APP_NAME }}
            -Dsonar.sources=.
            -Dsonar.python.version=3.9
            -Dsonar.exclusions=**/__pycache__/**,**/venv/**

      - name: SonarQube Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ env.SONAR_HOST_URL }}
        continue-on-error: true
  
  snyk-scan:
    name: Snyk Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Snyk to check dependencies
        uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --file=requirements.txt --severity-threshold=medium --sarif-file-output=snyk-deps.sarif
      
      - name: Snyk Code Analysis
        uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: code test
          args: --sarif-file-output=snyk-code.sarif
      
      - name: Upload Snyk results to GitHub
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk-deps.sarif
          category: snyk-dependencies

      - name: Upload Snyk Code results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: snyk-code.sarif
          category: snyk-code
  
  bandit-scan:
    name: Bandit Security Linter
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install Bandit
        run: pip install bandit[sarif]
      
      - name: Run Bandit scan
        run: |
          bandit -r . -f sarif -o bandit-report.sarif || true

      - name: Upload Bandit results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: bandit-report.sarif
          category: bandit
  
  security-summary:
    name: Stage 1 Summary
    runs-on: ubuntu-latest
    needs: [sonarqube-scan, snyk-scan, bandit-scan]
    if: always()
    
    steps:
      - name: Stage 1 Complete
        run: |
          echo "‚úÖ Stage 1: SAST & SCA completed"
          echo "üìä SonarQube: Code quality analysis done"
          echo "üîç Snyk: Dependency & code scanning done"
          echo "üêç Bandit: Python security linting done"
          echo "‚û°Ô∏è  Proceeding to Stage 2"
